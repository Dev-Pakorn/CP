/* timer.js (Final Version: No User Extend) */

let timerInterval; 

document.addEventListener('DOMContentLoaded', () => {
    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ DB
    if (typeof DB === 'undefined') {
        document.body.innerHTML = '<div class="alert alert-danger m-5 text-center"><h3>‚ùå Error</h3><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (DB is not defined)</p></div>';
        return;
    }

    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ Session
    const session = DB.getSession();
    if (!session || !session.startTime) {
        alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà');
        window.location.href = 'index.html';
        return;
    }

    // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const userName = session.user ? session.user.name : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
    document.getElementById('userNameDisplay').innerText = userName;
    
    const pcIdDisplay = session.pcId ? session.pcId.toString().padStart(2,'0') : '??';
    document.getElementById('pcNameDisplay').innerText = `Station: PC-${pcIdDisplay}`;
    
    // 4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
    if (session.forceEndTime) {
        // Mode A: ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏ö (Limited Time)
        setupCountdownMode(session);
    } else {
        // Mode B: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (Unlimited)
        setupUnlimitedMode();
    }
});

// --- Setup Modes ---
function setupCountdownMode(session) {
    console.log("Mode: Countdown (Slot-based)");
    const label = document.getElementById('timerLabel');
    if(label) label.innerText = "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (Remaining Time)";
    
    // (‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° btnExtend ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)

    updateCountdownSlot(); 
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateCountdownSlot, 1000); 
    
    // Sync
    setInterval(syncWithAdminUpdates, 5000);
}

function setupUnlimitedMode() {
    console.log("Mode: Normal Timer (Elapsed)");
    const label = document.getElementById('timerLabel');
    if(label) label.innerText = "‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (Elapsed Time)";

    // (‡πÄ‡∏≠‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° btnExtend ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
    
    updateTimer(); 
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimer, 1000); 
    
    // Sync
    setInterval(syncWithAdminUpdates, 5000);
}

// --- Mode 1: ‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (Unlimited) ---
function updateTimer() {
    const session = DB.getSession(); 
    if (!session) return;
    const now = Date.now();
    let diff = now - session.startTime;
    if (diff < 0) diff = 0;
    
    const timerDisplay = document.getElementById('timerDisplay');
    if(timerDisplay) {
        timerDisplay.innerText = formatTime(diff);
        timerDisplay.classList.remove('text-danger', 'fw-bold'); // Reset style
    }
}

// --- Mode 2: ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á (Countdown ‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö) ---
function updateCountdownSlot() {
    const session = DB.getSession();
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏ö ‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏Å‡∏±‡∏ô Error)
    if (!session || !session.forceEndTime) {
        setupUnlimitedMode();
        return;
    }

    // 1. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏ö (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô) ‡πÄ‡∏ä‡πà‡∏ô 10:30 = 630 ‡∏ô‡∏≤‡∏ó‡∏µ
    const endMinutesTotal = parseInt(session.forceEndTime); 
    
    // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target) ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‡πÄ‡∏™‡∏°‡∏≠
    const now = new Date();
    const targetDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    
    // ‡∏ö‡∏ß‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
    const targetHour = Math.floor(endMinutesTotal / 60);
    const targetMin = endMinutesTotal % 60;
    targetDate.setHours(targetHour, targetMin, 0, 0);

    // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (Milliseconds)
    const diff = targetDate.getTime() - now.getTime();

    const timerDisplay = document.getElementById('timerDisplay');

    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß (Diff ‡∏ï‡∏¥‡∏î‡∏•‡∏ö)
    if (diff <= 0) {
        if (timerInterval) clearInterval(timerInterval);
        if(timerDisplay) {
            timerDisplay.innerText = "00:00:00";
            timerDisplay.classList.add('text-danger', 'fw-bold');
            timerDisplay.classList.remove('text-dark'); // ‡πÄ‡∏≠‡∏≤‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å
        }
        
        // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏õ‡πä‡∏ö‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏•‡∏Ç 00:00:00)
        setTimeout(() => {
            handleTimeUp();
        }, 500);
        return;
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥
    if (timerDisplay) {
        timerDisplay.innerText = formatTime(diff);

        // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ä‡πà‡∏ß‡∏á 5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        if (diff < 5 * 60 * 1000) { 
            timerDisplay.classList.remove('text-dark');
            timerDisplay.classList.add('text-danger');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤)
            showAlert('‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            
            // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏ô‡∏≤‡∏ó‡∏µ
            if (diff < 60 * 1000) {
                timerDisplay.style.opacity = (new Date().getMilliseconds() < 500) ? '1' : '0.5';
            }
        } else {
            timerDisplay.classList.remove('text-danger');
            timerDisplay.classList.add('text-dark');
            timerDisplay.style.opacity = '1';
            hideAlert();
        }
    }
}

// ‚úÖ‚úÖ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö Admin ‚úÖ‚úÖ‚úÖ
function syncWithAdminUpdates() {
    const session = DB.getSession(); 
    if (!session || !session.pcId) return;

    // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å DB (‡∏ó‡∏µ‡πà Admin ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
    const pcs = DB.getPCs();
    const pc = pcs.find(p => String(p.id) === String(session.pcId));

    if (pc) {
        // ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡πÇ‡∏î‡∏ô Force Logout ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        if (pc.status !== 'in_use' || pc.currentUser !== session.user.name) {
            alert("‚ö†Ô∏è Admin ‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß");
            DB.clearSession();
            window.location.href = 'index.html';
            return;
        }

        // ‡∏Å‡∏£‡∏ì‡∏µ 2: Admin ‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ (forceEndTime ‡πÉ‡∏ô DB ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Session)
        const dbForceTime = pc.forceEndTime;
        const localForceTime = session.forceEndTime;

        if (dbForceTime !== localForceTime) {
            console.log(`üîÑ Time Updated! DB: ${dbForceTime}, Local: ${localForceTime}`);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Session ‡∏ù‡∏±‡πà‡∏á User ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö DB
            session.forceEndTime = dbForceTime;
            DB.setSession(session);

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà
            if (dbForceTime) {
                setupCountdownMode(session);
            } else {
                setupUnlimitedMode();
            }
            
            hideAlert();
        }
    }
}

// (‡∏•‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô tryExtendSession ‡πÅ‡∏•‡∏∞ getCurrentSlotFromTime ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î
function handleTimeUp() {
    // ‡∏õ‡∏£‡∏±‡∏ö Logic ‡πÉ‡∏´‡πâ Check-out ‡πÄ‡∏•‡∏¢‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤
    alert("‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß\n‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Check-out ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥");
    doCheckout(true);
}

// --- Helpers UI ---
function formatTime(ms) {
    const h = Math.floor(ms / 3600000).toString().padStart(2, '0');
    const m = Math.floor((ms % 3600000) / 60000).toString().padStart(2, '0');
    const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
    return `${h}:${m}:${s}`;
}

function showAlert(msg) {
    const box = document.getElementById('alertBox');
    const txt = document.getElementById('alertMsg');
    if(box && txt) {
        box.classList.remove('d-none');
        txt.innerText = msg;
    }
}

function hideAlert() {
    const box = document.getElementById('alertBox');
    if(box) box.classList.add('d-none');
}

function doCheckout(isAuto = false) {
    if (!isAuto && !confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    if (timerInterval) clearInterval(timerInterval);

    const session = DB.getSession();
    if (!session) { window.location.href = 'index.html'; return; }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
    const endTime = Date.now();
    const durationMilliseconds = endTime - session.startTime;
    const durationMinutes = Math.round(durationMilliseconds / 60000); 

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡πà‡∏≤‡∏á"
    DB.updatePCStatus(session.pcId, 'available', null);

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Session ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Feedback
    session.durationMinutes = durationMinutes; 
    DB.setSession(session);
    
    window.location.href = 'feedback.html';
}